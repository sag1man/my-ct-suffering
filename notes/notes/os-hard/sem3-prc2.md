# Memory allocators 
---

[[index|Конспекты]] / [[notes/os-hard/index|Операционные системы (hard)]] / [[notes/os-hard/sem3-prc2|Практика 2 - Memory allocators]]

--- 
## Аллокаторы памяти
##### Определение 
> Аллокатор - это сущность, которая умеет аллоцировать и освобождать память, то есть выполнять операции:
> - `malloc(n)` $\to$ `address`
> - `free(address)`

### Реализация на linked-list (примитивный вариант)
##### Идея
- Можно поделить память на блоки, проинициализируем связный список обозначающий наши блоки. 
- При запросе программы будем брать первый блок, удаляя его из листа, и будем класть при освобождении.

##### Проблемы
- Если блоки большие - у процесса может быть много пустого пространства, которое ему не нужно.
- Если маленькие - будем выделять сразу много блоков (неэффективно).
- Большая проблема - фрагментация, когда у нас оставшееся место получается разрозненным, мы не можем его выделить сразу полостью

![[pictures/os-hard-s3-prc2-img1.png]]

### Buddy allocator (доработанный вариант)
##### Эффективность 
> - Умеет аллоцировать блоки размера $2^i$
> - Выделает блоки за $\mathcal O(\log{n})$

#### Реализация
- Введем понятие `level` это число от `0` до `k`, которое отвечает за размер блока. 
- Для оптимизации договоримся, что минимальный блок не 1 байт, а чуть больше (захардкодим константу `MIN_BLOCK_SIZE`).
- Тогда зададим размер блока как `MIN_BLOCK_SIZE` * $2^{level}$.

##### `list[level]` 
- Создадим массив `list[level]`, где для каждого возможного размера блока заведем по связному списку блоков

##### Служебные массивы
- `free[level][id]` - способ проверять свободен ли определённый блок, определённого размера (используем bitset для экономии памяти)
- `split[level][id]` - способ проверять, не разделен ли определённый блок (снова используем bitset)

![[pictures/os-hard-s3-prc2-img2.png]]

С помощью двух этим массивов мы и как раз можем быстро понимать текущее состояние памяти, для управления ею

##### Выделение памяти
- Изначально проинициализируем память одним блоком максимального размера.
- Смотрим на свободные блоки: если есть свободный блок, но его размер больше в 2+ раза, чем запрашиваемая память, то мы его сплитим на блоки в 2 раза меньше, и повторяем проверку

![[pictures/os-hard-s3-prc2-img3.png]]

##### Освобождение памяти
- Меняем статус блока на `free`, при возможности мерджим соседние блоки, пока это возможно

##### Оптимизация
- Заметим, что `free` мы используем только чтобы мерджить 2 соседних блока. 
- Заметим, что мы можем хранить free не для каждого блока, для каждой пары хранить xor от `free`.